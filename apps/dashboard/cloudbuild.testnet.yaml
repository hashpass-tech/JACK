steps:
  # Upload assets to GCS bucket
  - name: gcr.io/cloud-builders/gcloud
    entrypoint: bash
    args:
      - -c
      - |
        echo "Uploading assets to GCS..."
        # Sync videos directory
        gsutil -m rsync -r -d apps/dashboard/public/videos gs://jack-dashboard-testnet-assets/videos
        # Copy individual asset files
        gsutil -m cp apps/dashboard/public/*.png gs://jack-dashboard-testnet-assets/ 2>/dev/null || true
        gsutil -m cp apps/dashboard/public/*.ico gs://jack-dashboard-testnet-assets/ 2>/dev/null || true
        gsutil -m cp apps/dashboard/public/*.webmanifest gs://jack-dashboard-testnet-assets/ 2>/dev/null || true
        # Set cache headers
        gsutil -m setmeta -h "Cache-Control:public, max-age=31536000, immutable" gs://jack-dashboard-testnet-assets/** 2>/dev/null || true
        echo "Assets uploaded successfully"

  # Build Docker image
  - name: gcr.io/cloud-builders/docker
    args:
      - build
      - .
      - -f
      - apps/dashboard/Dockerfile
      - --build-arg
      - NEXT_PUBLIC_IS_TESTNET=true
      - --build-arg
      - NEXT_PUBLIC_CDN_URL=https://storage.googleapis.com/jack-dashboard-testnet-assets
      - -t
      - ${_IMAGE}

  # Push Docker image
  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - ${_IMAGE}

  # Deploy to Cloud Run
  - name: gcr.io/cloud-builders/gcloud
    args:
      - run
      - deploy
      - ${_SERVICE}
      - --image
      - ${_IMAGE}
      - --region
      - ${_REGION}
      - --project
      - ${_PROJECT}
      - --allow-unauthenticated
      - --set-env-vars
      - NEXT_PUBLIC_CDN_URL=https://storage.googleapis.com/jack-dashboard-testnet-assets
images:
  - ${_IMAGE}
substitutions:
  _SERVICE: jack-dashboard-testnet
  _REGION: us-west1
  _PROJECT: lsts-482607
  _IMAGE: us-west1-docker.pkg.dev/lsts-482607/cloud-run-source-deploy/jack-dashboard-testnet:latest
timeout: 1800s
